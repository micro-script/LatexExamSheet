%
% Copyright (c) 2022 Zeping Lee
% Released under the LaTeX Project Public License v1.3c License.
% Repository: https://gitee.com/zepinglee/exam-zh
%

\NeedsTeXFormat{LaTeX2e}

\RequirePackage{expl3}
\RequirePackage{xparse}

\ProvidesExplPackage {exam-zh-question} {2022-07-19} {v0.1.10}
  {exam-zh question module}

\RequirePackage { amsthm }
\@ifpackageloaded { tcolorbox }
  { \tcbuselibrary { breakable } }
  { \RequirePackage [ most ] { tcolorbox } }
\RequirePackage { zref-savepos }
\RequirePackage { ulem }

\ExplSyntaxOff
\usetikzlibrary{shapes.misc}
\ExplSyntaxOn



\NewDocumentCommand \questionsetup { m }
  { \keys_set:nn { exam-zh / question } { #1 } }
\NewDocumentCommand \fillinsetup { m }
  { \keys_set:nn { exam-zh / fillin } { #1 } }

% ulem å®åŒ…é‡å®šä¹‰äº† \emphï¼Œä½¿ç”¨ \normalem æ¢å¤
\normalem


% question ç¯å¢ƒç›¸å…³å˜é‡

% è®¡æ•°å™¨
\int_new:N \g__examzh_question_index_int
% ç­”æ¡ˆé¢œè‰²
\tl_new:N \l__examzh_question_answer_color_tl
% é¢˜ç›®åˆ†æ•°
\int_new:N \l__examzh_question_points_int
% æ˜¯å¦æ˜¾ç¤ºé¢˜ç›®åˆ†æ•°
\bool_new:N \l__examzh_question_show_points_bool
\bool_new:N \l__examzh_question_show_points_auto_bool
% é¢˜ç›®åˆ†æ•°æ˜¯å¦å•ç‹¬æˆæ®µï¼Œè§£ç­”é¢˜éœ€è¦å•ç‹¬æˆæ®µ
\bool_new:N \l__examzh_question_points_separate_par_bool
% æ˜¯å¦æ˜¾ç¤ºæ‹¬å·
\bool_new:N \l__examzh_question_show_paren_bool
% æ˜¯å¦æ˜¾ç¤ºç­”æ¡ˆ
\bool_new:N \l__examzh_question_show_answer_bool
\bool_new:N \l__examzh_question_show_fillin_answer_bool
\bool_new:N \l__examzh_question_show_paren_answer_bool
% ä¸Šä¸‹çš„é—´è·
\skip_new:N \l__examzh_question_top_sep_skip
\skip_new:N \l__examzh_question_bottom_sep_skip


\keys_define:nn { exam-zh }
  { question .meta:nn = { exam-zh / question } {#1} }


\keys_define:nn { exam-zh / question }
  {
    % æ‰‹åŠ¨è°ƒæ•´ question ç¯å¢ƒçš„è®¡æ•°å™¨
    index               .int_gset:N = \g__examzh_question_index_int ,
    % åˆ†æ•°
    points              .int_set:N = \l__examzh_question_points_int ,
    % åˆ†æ•°æ˜¾ç¤ºæ§åˆ¶
    show-points         .choice: ,
    show-points / auto  .code:n =
      { \bool_set_true:N \l__examzh_question_show_points_auto_bool } ,
    show-points / true  .code:n =
      {
        \bool_set_true:N  \l__examzh_question_show_points_bool
        \bool_set_false:N \l__examzh_question_show_points_auto_bool
      } ,
    show-points / false .code:n =
      {
        \bool_set_false:N \l__examzh_question_show_points_bool
        \bool_set_false:N \l__examzh_question_show_points_auto_bool
      } ,
    % åˆ†æ•°æ˜¯å¦å•ç‹¬æˆæ®µ
    points-separate-par .bool_set:N = \l__examzh_question_points_separate_par_bool ,
    % æ˜¯å¦æ˜¾ç¤ºç­”æ¡ˆ
    % show-answer         .bool_set:N = \l__examzh_question_show_answer_bool ,
    show-answer         .choice: ,
    show-answer / true .code:n = 
      {
        \bool_set_true:N \l__examzh_question_show_fillin_answer_bool
        \bool_set_true:N \l__examzh_question_show_paren_answer_bool
      },
    show-answer / false .code:n = 
      {
        \bool_set_false:N \l__examzh_question_show_fillin_answer_bool
        \bool_set_false:N \l__examzh_question_show_paren_answer_bool
      },
    % ä¸Šæ–¹é—´è·
    top-sep             .skip_set:N = \l__examzh_question_top_sep_skip ,
    % ä¸‹æ–¹é—´è·
    bottom-sep          .skip_set:N = \l__examzh_question_bottom_sep_skip ,
    label .tl_set:N = \l__examzh_question_label_tl,
  }

\keys_set:nn { exam-zh / question }
  {
    points              = 0 ,
    show-points         = auto ,
    points-separate-par = false ,
    show-answer         = false ,
    top-sep             = .5em plus .5em minus .2em ,
    bottom-sep          = .5em plus .5em minus .2em ,
    label               = \arabic*.,
  }



% æ˜¯å¦æŒ‰ç…§è§£ç­”é¢˜çš„æ ¼å¼æ’ç‰ˆ
\bool_new:N \l__examzh_question_problem_style_bool


% é€‰æ‹©é¢˜å’Œå¡«ç©ºé¢˜çš„é¢˜å¹²
\NewDocumentEnvironment { question } { O { } +b }
  {
    \bool_set_false:N \l__examzh_question_problem_style_bool
    \__examzh_question_begin:nn {#1}{#2}
  }
  { \__examzh_question_end:nn {#1}{#2} }

% è§£ç­”é¢˜
\NewDocumentEnvironment { problem } { O { } +b }
  {
    \bool_set_true:N \l__examzh_question_problem_style_bool
    \__examzh_question_begin:nn {#1}{#2}
  }
  { \__examzh_question_end:nn {#1}{#2} }


\cs_new:Npn \__examzh_question_begin:nn #1#2
  {
    \par
    % é¢˜å¹²è®¡æ•°å™¨çš„å€¼åŠ ä¸€
    \int_gincr:N \g__examzh_question_index_int
    % æ ¹æ®æ˜¯å¦æŒ‰è§£ç­”é¢˜æ–¹å¼æ’ç‰ˆæ¥è®¾ç½®æ˜¯å¦åˆ†æ•°è¦åˆ†æ®µ
    \bool_if:NTF \l__examzh_question_problem_style_bool
      { \keys_set:nn { exam-zh / question } { points-separate-par = true  } }
      { \keys_set:nn { exam-zh / question } { points-separate-par = false } }
    % è®¾ç½®é”®å€¼
    \keys_set:nn { exam-zh / question } { #1 }
    % è®¾ç½®ä¸Šæ–¹é—´è·
    \addvspace { \l__examzh_question_top_sep_skip }
    % ä¸¥æ ¼ç¦æ­¢å­¤è¡Œå’Œå¯¡è¡Œ
    \int_set:Nn \clubpenalty { 10000 }
    \int_set:Nn \widowpenalty { 10000 }
    % å°½é‡é¿å…åœ¨é¢˜ç›®ä¸­é—´æ¢è¡Œ
    \int_set:Nn \interlinepenalty { 301 }
    % è¿™éƒ¨åˆ†æ˜¯ä»¿ç…§ source2e ä¸­ enumerate çš„å®šä¹‰å†™çš„
    % \@enumdepth ä¸»è¦æ§åˆ¶ enumerate ä¸åŒå±‚çº§çš„ç¼–å·
    % è¿™æ ·è®¾ç½®åï¼Œåœ¨ question ä¸­ä½¿ç”¨ enumerate ä¼šè°ƒç”¨ level 2 çš„ç¼–å·
    % ä¹Ÿå°±æ˜¯ question ä¸­çš„ enumerate ç¯å¢ƒç›´æ¥ä»ç¬¬äºŒå±‚å¼€å§‹
    \int_incr:N \@enumdepth
    % å¦‚æœ show-points = auto é‚£ä¹ˆè§£ç­”é¢˜æ˜¾ç¤ºåˆ†æ•°ï¼Œé€‰æ‹©é¢˜å’Œå¡«ç©ºé¢˜ä¸æ˜¾ç¤ºåˆ†æ•°
    % è¿™æ ·è®¾ç½®è€ƒè™‘åˆ°é€‰æ‹©é¢˜å’Œå¡«ç©ºé¢˜éƒ½æ˜¯æ¯é“é¢˜ä¸€æ ·çš„åˆ†æ•°ï¼Œåœ¨æœ€å¼€å§‹çš„åœ°æ–¹è¯´æ˜å³å¯
    % è€Œè§£ç­”é¢˜ä¸å¤ªä¸€æ ·
    \bool_if:NT \l__examzh_question_show_points_auto_bool
      {
        \bool_if:NTF \l__examzh_question_problem_style_bool
          { \bool_set_true:N  \l__examzh_question_show_points_bool }
          { \bool_set_false:N \l__examzh_question_show_points_bool }
      }
    % ä½¿ç”¨åˆ—è¡¨ç¯å¢ƒè¾“å‡º
    \list 
      {
        % \int_use:N \g__examzh_question_index_int . 
        \__examzh_question_the_label:
      }
      {
        \dim_set:Nn \topsep    { 0pt }
        \dim_set:Nn \partopsep { 0pt }
        \dim_set:Nn \itemsep   { 0pt }
        \dim_set:Nn \parsep    { 0pt }
        \bool_if:NTF \l__examzh_question_problem_style_bool
          {
            % è§£ç­”é¢˜æ˜¯æ­£æ–‡ + ç¼©è¿› 2em çš„æ•ˆæœ
            \dim_set:Nn \leftmargin { 0pt }
            \dim_set:Nn \itemindent { 2em }
          }
          {
            % é€‰æ‹©å’Œå¡«ç©ºé¢˜æ˜¯æ‚¬æŒ‚æ•ˆæœ
            \dim_set:Nn \leftmargin { 2em }
            \dim_set:Nn \itemindent { 0pt }
          }
        \dim_set:Nn \labelsep   { .7em  }
        \dim_set:Nn \labelwidth { 1.3em }
        \dim_set_eq:NN \listparindent \itemindent
      }
    \item \relax
    % è¾“å‡ºé¢˜ç›®åˆ†æ•°
    \bool_if:NT \l__examzh_question_show_points_bool
      {
        % å¦‚æœè®¾ç½®äº†åˆ†æ•°ä¸” show-points çš„ bool æ˜¯ true çš„è¯å°±æ˜¾ç¤º
        \int_compare:nNnT { \l__examzh_question_points_int } > { 0 }
          { ï¼ˆ \int_use:N \l__examzh_question_points_int ~ åˆ† ï¼‰ }
        % æ˜¯å¦åˆ†æ®µï¼ˆè§£ç­”é¢˜éœ€è¦åˆ†æ®µï¼‰
        \bool_if:NT \l__examzh_question_points_separate_par_bool
          % \par åˆ†æ®µä¹‹åä½¿ç”¨ \nopagebreak é¿å…åˆ†é¡µå¯¼è‡´åºå·å’Œåˆ†æ•°å‡ºç°åœ¨é¡µé¢æœ€åä¸€è¡Œ
          { \par \nopagebreak }   
      }
  }


\cs_new:Npn \__examzh_question_end:nn #1#2
  {
    #2
    % ç»“æŸåˆ—è¡¨ç¯å¢ƒ
    \endlist
    % å¢åŠ ä¸‹æ–¹é—´è·
    \addvspace { \l__examzh_question_bottom_sep_skip }
  }

% å¤„ç† question / problem çš„ label
\tl_new:N \l__examzh_question_counters_commands_set_tl

\cs_new:Npn \__examzh_question_the_label:
  {
    \group_begin:
      % å®šä¹‰è®¡æ•°å™¨ç›¸å…³çš„å‘½ä»¤å‡½æ•°
      \l__examzh_question_counters_commands_set_tl
      % è¾“å‡ºå¤„ç†åçš„ label
      \l__examzh_question_label_tl
    \group_end:
  }

\NewDocumentCommand \AddQuestionCounter { m m }
  {
    % ç”Ÿæˆç”¨æˆ·å±‚å‘½ä»¤
    \tl_put_right:Nn \l__examzh_question_counters_commands_set_tl
      { \__examzh_question_process_counter:NN #1 #2 }
    % æŠŠæ ¸å¿ƒå‡½æ•°å­˜èµ·æ¥
    \cs_set_eq:cN { __examzh_question_save_ \cs_to_str:N #1 : } #2
    \cs_set_eq:cN { __examzh_question_save_ \cs_to_str:N #2 : } #2
  }

\AddQuestionCounter \arabic \@arabic
\AddQuestionCounter \alph   \@alph
\AddQuestionCounter \Alph   \@Alph
\AddQuestionCounter \roman  \@roman
\AddQuestionCounter \Roman  \@Roman

\cs_new:Npn \__examzh_question_process_counter:NN #1#2
  % #1: \Alph
  % #2: \@Alph
  {
    \cs_set:Npn #1 { \__examzh_question_process_counter_aux:Nn #2 }
    \cs_set:Npn #2 { \__examzh_question_process_counter_aux:Nn #2 }
  }

\cs_new:Npn \__examzh_question_process_counter_aux:Nn #1#2
  {
    \tl_if_eq:nnTF {#2} { * }
      {
        % \Alph*
        \use:c { __examzh_question_save_ \cs_to_str:N #1 : }
          { \g__examzh_question_index_int }
      }
      {
        % \Alph{...}
        \use:c { __examzh_question_save_ \cs_to_str:N #1 : }
          {#2}
      }
  }

% ä½¿ç”¨ä¸­æ–‡å­—ä½“ç›´æ¥è¾“å‡º unicode å¸¦åœˆæ•°å­—
% \questioncirclednumber çš„å‚æ•°æ—¢å¯ä»¥æ¥å— LaTeX2e çš„ <counter>ï¼Œä¹Ÿå¯ä»¥ç›´æ¥æ¥å— <intexpr>ã€‚
\NewDocumentCommand \questioncirclednumber { m }
  {
    \int_if_exist:cTF { c@ #1 }
      { \int_set_eq:Nc \l_tmpa_int { c@#1 } }
      { \int_set:Nn \l_tmpa_int { #1 } }
    \exp_args:Nx \__examzh_question_circled_number:n { \int_use:N \l_tmpa_int }
  }

\cs_new:Npn \__examzh_question_circled_number:n #1
  {
    \int_set:Nn \l_tmpa_int {#1}
    \int_compare:nNnTF { \l_tmpa_int } = { 0 }
      { \int_set:Nn \l_tmpa_int { "24EA } }
      {
        \int_compare:nNnTF { \l_tmpa_int } < { 21 }
          { \int_add:Nn \l_tmpa_int { "245F } }
          {
            \int_compare:nNnTF { \l_tmpa_int } < { 36 }
              { \int_add:Nn \l_tmpa_int { "3250 } }
              {
                \int_compare:nNnTF { \l_tmpa_int } < { 51 }
                  { \int_add:Nn \l_tmpa_int { "32B0 } }
                  {
                    \msg_error:nnn { exam-zh / question }
                      { invalid-circled-number } { \int_use:N \l_tmpa_int }
                  }
              }
          }
      }
    \group_begin:
      % TODO ä¸ºä½•è¦ç”¨ \CJKfamily+ { }
      % xeCJK å®åŒ…æ–‡æ¡£ï¼šå½“ \CJKfamily+ å‚æ•°ä¸ºç©ºæ—¶ï¼Œåˆ™ä½¿ç”¨å½“å‰çš„ CJK å­—ä½“æ—ã€‚
      \CJKfamily+ { }
      \symbol { \l_tmpa_int }
    \group_end:
  }

\msg_new:nnn { exam-zh / question } { invalid-circled-number }
{ Invalid~ circled~ number~ #1. }

\AddQuestionCounter \questioncirclednumber \__examzh_question_circled_number:n



% é€‰æ‹©é¢˜æ‹¬å·
% æ§åˆ¶æ‹¬å·æ˜¯å¦å³å¯¹é½
\bool_new:N \l__examzh_paren_type_hfill_bool
\keys_define:nn { exam-zh / paren }
  {
    show-answer .bool_set:N = \l__examzh_question_show_paren_answer_bool,
    text-color        .tl_set:N = \l__examzh_paren_text_color_tl ,
    % æ˜¯å¦æ˜¾ç¤ºé€‰æ‹©é¢˜çš„æ‹¬å·
    show-paren          .bool_set:N = \l__examzh_question_show_paren_bool ,
    type .choice:,
    type / hfill .code:n =
      {
        \bool_set_true:N \l__examzh_paren_type_hfill_bool
      },
    type / none .code:n =
      {
        \bool_set_false:N \l__examzh_paren_type_hfill_bool
      },
  }
\keys_set:nn { exam-zh / paren }
  {
    show-answer = false,
    text-color  = black,
    show-paren  = false,
    type        = hfill
  }
\keys_define:nn { exam-zh }
  { paren .meta:nn = { exam-zh / paren } {#1} }
\NewDocumentCommand \paren { O { } }
  {
    % å¦‚æœå¼€äº† show answer å°±é»˜è®¤ show paren 
    \bool_if:NT \l__examzh_question_show_paren_answer_bool
      { \bool_set_true:N \l__examzh_question_show_paren_bool }
    \bool_if:NT \l__examzh_question_show_paren_bool
      {
        % ä½¿æ‹¬å·å•ç‹¬æˆè¡Œæ—¶å±…äºå³ä¾§
        % \null -> \hbox{}
        % ğ–…ğ–Šğ–•ğ–ğ–“ğ–Œ ğ•·ğ–Šğ–Š, [Mar 19, 2022 at 22:47:07]:
          % è¿™ä¸ªå†™æ³•æ˜¯ä¸ºäº†å¤„ç†è¿™æ ·çš„æƒ…å†µï¼šå‡è®¾æ‹¬å·éœ€è¦ 3em å®½åº¦ï¼Œä½†æ˜¯å¦‚æœé¢˜å¹²æœ«å°¾åªå‰©ä¸‹äº† 2em çš„ç©ºç™½ï¼Œæ‹¬å·å°±å¿…è¦å¦èµ·ä¸€è¡Œï¼Œå¹¶ä¸”ç”¨ \hill æŠŠæ‹¬å·æ¨åˆ°æœ€å³ä¾§
          % æ‰€ä»¥ä¸­é—´ç”¨äº†ä¸¤ä¸ª \hfill
          % è‡³äº \nobreak å’Œ \allowbreak å¤§æ¦‚æ˜¯ä¸ºäº†èƒ½å¤ŸåŒæ—¶å¤„ç†ã€Œæ‹¬å·ä¸æ¢è¡Œã€å’Œã€Œæ‹¬å·æ¢è¡Œã€ä¸¤ç§æƒ…å†µ
          % è¿™é‡Œå‚è€ƒ source2e çš„ \@dottedtoclineï¼ˆç›®å½•çš„æ ¼å¼ï¼‰
        % æ§åˆ¶æ˜¯å¦ hfill åˆ°è¡Œå°¾
        \bool_if:NT \l__examzh_paren_type_hfill_bool
          {
            \nobreak \hfill \allowbreak
            \null \nobreak \hfill \nobreak
          }
        \hbox:n
          {
            ï¼ˆ
            \hbox_to_wd:nn { 3em }
              {
                \bool_if:NT \l__examzh_question_show_paren_answer_bool
                  { \hfill \__examzh_paren_print_answer:n {#1} \hfill }
              }
            ï¼‰ \kern -.4em
          }
      }
  }
% â€œæ‰“å°å‡ºâ€ç­”æ¡ˆå†…å®¹ å› ä¸º show è¢«ç”¨ä½œâ€œæ˜¾ç¤ºä¸å¦â€çš„å«ä¹‰äº†ï¼Œæ‰€ä»¥æ­¤å¤„ç”¨ print
\cs_new:Npn \__examzh_fillin_print_answer:n #1
  {
    \group_begin:
      \tl_if_eq:NnF \l__examzh_fillin_text_color_tl { black }
        { \exp_args:NV \color \l__examzh_fillin_text_color_tl }
      #1
    \group_end:
  }
\cs_new:Npn \__examzh_paren_print_answer:n #1
  {
    \group_begin:
      \tl_if_eq:NnF \l__examzh_paren_text_color_tl { black }
        { \exp_args:NV \color \l__examzh_paren_text_color_tl }
      #1
    \group_end:
  }


% fillin çš„ä¸‹åˆ’çº¿æ ·å¼æ§åˆ¶
\str_new:N \l__examzh_fillin_type_str

\keys_define:nn { exam-zh / fillin }
  {
    type .code:n = 
      {
        \str_set:Nn \l__examzh_fillin_type_str {#1}
      },
    show-blacktriangle .bool_set:N = \l__examzh_fillin_show_blacktriangle_bool,
    show-answer .bool_set:N = \l__examzh_question_show_fillin_answer_bool,
    width .skip_set:N = \l__examzh_fillin_F_width_skip,
    color .tl_set:N = \l__examzh_fillin_color_tl,
    text-color .tl_set:N = \l__examzh_fillin_text_color_tl,
  }
\keys_set:nn { exam-zh / fillin }
  {
    type               = line,
    show-blacktriangle = true,
    show-answer        = false,
    width              = 3em plus 1em minus 1em,
    color              = black,
    text-color         = black,
  }

\keys_define:nn { exam-zh }
  { fillin .meta:nn = { exam-zh / fillin } {#1} }


\dim_new:N \l__examzh_question_answer_depth_dim

% å¡«ç©ºå‘½ä»¤
% \fillin \fillin[] \fillin[][] åœ¨ show-blacktriangle = true, show-answer = false çš„æƒ…å†µä¸‹å°±æ˜¾ç¤ºé»‘è‰²ä¸‰è§’å½¢
\NewDocumentCommand \fillin { O{} o }
  {
    \group_begin:
      \IfNoValueTF {#2}
        {
          % \fillin[]
          % \tl_if_blank:nTF {#1}
            % {
              \bool_lazy_and:nnTF
                {
                  !\bool_if_p:N \l__examzh_question_show_fillin_answer_bool
                }
                {
                  \bool_if_p:N \l__examzh_fillin_show_blacktriangle_bool
                }
                {
                  \__examzh_fillin_without_judge:n { \__examzh_fillin_blacktriangle: }
                }
                { \__examzh_fillin:n {#1} }
            % }
            % {
              % \__examzh_fillin:n {#1}
            % }
        }
        {
          % \fillin[][]
          \keys_set:nn { exam-zh / fillin }
            {#1}
          % \tl_if_blank:nTF {#2}
            % {
              \bool_lazy_and:nnTF
                {
                  !\bool_if_p:N \l__examzh_question_show_fillin_answer_bool
                }
                {
                  \bool_if_p:N \l__examzh_fillin_show_blacktriangle_bool
                }
                {
                  \__examzh_fillin_without_judge:n { \__examzh_fillin_blacktriangle: }
                }
                { \__examzh_fillin:n {#2} }
            % }
            % {
              % \__examzh_fillin:n {#2}
            % }
        }
      \group_end:
    \space \ignorespaces
  }
\cs_new:Npn \__examzh_fillin_without_judge:n #1
  {
    % \ULdepth æ˜¯ \uline çš„ä¸‹åˆ’çº¿çš„æ·±åº¦
    \dim_set:Nn \ULdepth { 0.3em }
    % lazy ç‰ˆæœ¬æ˜¯æŒ‡éœ€è¦åˆ¤æ–­æ—¶æ‰å»è·å–å½“å‰ç”¨äºåˆ¤æ–­çš„ bool å€¼ 
    % è€Œä¸æ˜¯ç±»ä¼¼äºâ€œæå‰å±•å¼€â€ï¼Œå’Œé¡¹å­è¶Šåœ¨ LaTeX3 çš„ bç«™è§†é¢‘é‡Œè®²åˆ°çš„ lazy evaluation æƒ³æ³•ç›¸åŒ
    \hbox_set:Nn \l_tmpa_box { \__examzh_fillin_print_answer:n {#1} }
    \dim_set:Nn \l__examzh_question_answer_depth_dim
      { \box_dp:N \l_tmpa_box }
    \__examzh_fillin_output_T:
  }
\cs_new:Npn \__examzh_fillin:n #1
  {
    % \ULdepth æ˜¯ \uline çš„ä¸‹åˆ’çº¿çš„æ·±åº¦
    \dim_set:Nn \ULdepth { 0.3em }
    % lazy ç‰ˆæœ¬æ˜¯æŒ‡éœ€è¦åˆ¤æ–­æ—¶æ‰å»è·å–å½“å‰ç”¨äºåˆ¤æ–­çš„ bool å€¼ 
    % è€Œä¸æ˜¯ç±»ä¼¼äºâ€œæå‰å±•å¼€â€ï¼Œå’Œé¡¹å­è¶Šåœ¨ LaTeX3 çš„ bç«™è§†é¢‘é‡Œè®²åˆ°çš„ lazy evaluation æƒ³æ³•ç›¸åŒ
    \bool_lazy_and:nnTF
      { \bool_if_p:N \l__examzh_question_show_fillin_answer_bool }
      { \bool_not_p:n { \tl_if_empty_p:n {#1} } }
      {
        \hbox_set:Nn \l_tmpa_box { \__examzh_fillin_print_answer:n {#1} }
        \dim_set:Nn \l__examzh_question_answer_depth_dim
          { \box_dp:N \l_tmpa_box }
        \__examzh_fillin_output_T:
      }
      { 
        \__examzh_fillin_output_F:
      }
  }
\msg_new:nnn { exam-zh } { no-fillin-type }
  {
    There~is~no~type~of~\fillin~named~#1!\\
    Please~read~the~manual~for~more~details.
  }
\cs_new:Npn \__examzh_fillin_output_T:
  {
    \str_case:VnF \l__examzh_fillin_type_str
      {
        { line } { \__examzh_fillin_uline_T: }
        { paren } { \__examzh_fillin_paren_T: }
        { circle } { \__examzh_fillin_circle_T: }
        { blank } { \__examzh_fillin_blank_T: }
        { rectangle } { \__examzh_fillin_rectangle_T: }
      }
      {
        \msg_error:nnx { exam-zh } { no-fillin-type }
          { \l__examzh_fillin_type_str }
      }
  }
\cs_new:Npn \__examzh_fillin_output_F:
  {
    \str_case:VnF \l__examzh_fillin_type_str
      {
        { line } { \__examzh_fillin_uline_F: }
        { paren } { \__examzh_fillin_paren_F: }
        { circle } { \__examzh_fillin_circle_F: }
        { blank } { \__examzh_fillin_blank_F: }
        { rectangle } { \__examzh_fillin_rectangle_F: }
      }
      {
        \msg_error:nnx { exam-zh } { no-fillin-type }
          { \l__examzh_fillin_type_str }
      }
  }
\cs_new:Npn \__examzh_fillin_uline_T:
  {
    \uline
      {
        \hspace* { 1em plus .5em minus .5em }
        \dim_compare:nNnTF { \l__examzh_question_answer_depth_dim } > { 0.2em }
          {
            \dim_sub:Nn \l__examzh_question_answer_depth_dim { 0.2em }
            \raisebox { \l__examzh_question_answer_depth_dim }
              { \box_use_drop:N \l_tmpa_box }
          }
          { \box_use_drop:N \l_tmpa_box }
        \hspace* { 1em plus .5em minus .5em }
      }
  }
\cs_new:Npn \__examzh_fillin_uline_F:
  {
    \uline { \hspace* { \l__examzh_fillin_F_width_skip } } 
  }
\cs_new:Npn \__examzh_fillin_paren_T:
  {
    (
      \hspace* { 1em plus .5em minus .5em }
      \box_use_drop:N \l_tmpa_box
      \hspace* { 1em plus .5em minus .5em }
    )
  }
\cs_new:Npn \__examzh_fillin_paren_F:
  {
    ( \hspace* { \l__examzh_fillin_F_width_skip} )
  }
\cs_new:Npn \__examzh_fillin_blank_T:
  {
    \hspace* { 1em plus .5em minus .5em }
    \box_use_drop:N \l_tmpa_box 
    \hspace* { 1em plus .5em minus .5em }
  }
\cs_new:Npn \__examzh_fillin_blank_F:
  {
    \hspace* { \l__examzh_fillin_F_width_skip }
  }
\tikzset
  {
    fillin-circle/.style = 
      {
        rounded~rectangle~west~arc = convex,
        draw, rounded~rectangle,
        color = \l__examzh_fillin_color_tl, text = \l__examzh_fillin_text_color_tl
      }
  }
\cs_new:Npn \__examzh_fillin_circle_T:
  {
    \hspace* { .5em minus .5em }
    \tikz[baseline=-3pt]
      {
        \node [fillin-circle] at (0,0) 
          { \box_use_drop:N \l_tmpa_box };
      }
    \hspace* { .5em minus .5em }
  }
\cs_new:Npn \__examzh_fillin_circle_F:
  {
    \hspace* { 1em plus .5em minus .5em }
    \tikz[baseline=-3pt]
      {
        \node [fillin-circle] at (0,0) 
          { \phantom{t} };
      }
    \hspace* { 1em plus .5em minus .5em }
  }
\cs_new:Npn \__examzh_fillin_rectangle_T:
  {
    \hspace* { .5em minus .5em }
    \begin{tikzpicture}[baseline = -3pt]
      \node[draw, color = \l__examzh_fillin_color_tl, text = \l__examzh_fillin_text_color_tl] 
        { \box_use_drop:N \l_tmpa_box };
    \end{tikzpicture}
    \hspace* { .5em minus .5em }
  }
\cs_new:Npn \__examzh_fillin_rectangle_F:
  {
    \hspace* { 1em plus .5em minus .5em }
    \begin{tikzpicture}[baseline = -3pt]
      \node[draw, color = \l__examzh_fillin_color_tl, text = \l__examzh_fillin_text_color_tl] 
        { \phantom{a} };
    \end{tikzpicture}
    \hspace* { 1em plus .5em minus .5em }
  }


\dim_new:N \l__examzh_blacktriangle_length_dim
\dim_set:Nn \l__examzh_blacktriangle_length_dim { .7em }
\cs_new:Npn \__examzh_fillin_blacktriangle:
  {
    \tikz[rounded~corners=0.5pt,baseline=0pt]
      {
        \fill[] (0,0) -- ++(60\c_colon_str \l__examzh_blacktriangle_length_dim) -- ++(-60\c_colon_str \l__examzh_blacktriangle_length_dim) -- cycle ;
      }
  }

\str_new:N \l__examzh_solution_blank_type_str
\keys_define:nn { exam-zh / solution }
  {
    show-solution .bool_set:N = \l__examzh_solution_show_bool,
    show-qed      .bool_set:N = \l__examzh_solution_show_qed_bool,
    qedsymbol     .tl_set:N = \l__examzh_solution_qedsymbol_tl,
    label-content  .tl_set:N   = \l__examzh_solution_label_content_tl,
    label-punct    .tl_set:N   = \l__examzh_solution_label_punct_tl,
    score-showleader .bool_set:N = \l__examzh_score_show_leader_bool,
    score-pre-content .tl_set:N = \l__examzh_score_pre_content_tl,
    score-post-content .tl_set:N = \l__examzh_score_post_content_tl,
    score-format .tl_set:N = \l__examzh_score_format_tl,
    text-color .tl_set:N = \l__examzh_solution_text_color_tl,
    blank-type .choices:nn =
      { none, manual, hide }
      {
        \str_set:Nx \l__examzh_solution_blank_type_str { \l_keys_choice_tl }
      },
    blank-vsep .skip_set:N = \l__examzh_solution_blank_vsep_skip,
    top-sep    .skip_set:N = \l__examzh_solution_top_sep_skip,
    bottom-sep .skip_set:N = \l__examzh_solution_bottom_sep_skip,
  }
\keys_set:nn { exam-zh / solution }
  {
    show-solution      = false,
    show-qed           = true,
    qedsymbol          = $\square$,
    label-content      = {è§£ç­”},
    label-punct        = {},
    score-showleader   = true,
    score-pre-content  = {},
    score-post-content = åˆ†,
    score-format       = \color{red},
    text-color         = black,
    blank-type         = none,
    blank-vsep         = 12ex plus 1ex minus 1ex,
    top-sep            = .5em plus .5em minus .2em,
    bottom-sep         = .5em plus .5em minus .2em 
  }
\keys_define:nn { exam-zh }
  { solution .meta:nn = { exam-zh / solution } {#1} }
% è§£ç­”é¢˜ç¯å¢ƒ
\NewDocumentEnvironment { solution } { O{ } +b }
  {
    % \addvspace { \l__examzh_solution_top_sep_skip }
    \vspace { \l__examzh_solution_top_sep_skip }
    \keys_set:nn { exam-zh / solution } {#1}
    % æ”¾åœ¨è¿™æ˜¯ä½¿å¾— \examsetup è®¾ç½® qedsymbol å¯ä»¥æ”¾åœ¨æ­£æ–‡åŒº
    \cs_set_eq:NN \qedsymbol \l__examzh_solution_qedsymbol_tl
    \bool_if:NTF \l__examzh_solution_show_bool
      {
        \__examzh_solution_print_answer:n {#2}
      }
      {
        \str_case:VnF \l__examzh_solution_blank_type_str
          {
            { none } { }
            { manual } { \addvspace { \l__examzh_solution_blank_vsep_skip } }
            { hide } { \__examzh_solution_simply_hide_solution:n {#2} }
          }
          {}
      }
    \par
    % \mode_leave_vertical:
    % \addvspace { \l__examzh_solution_bottom_sep_skip }
    \vspace { \l__examzh_solution_bottom_sep_skip }
  }
  {}
\cs_new:Npn \__examzh_solution_simply_hide_solution:n #1
  {
    \begin{tcolorbox}
      [
        invisible,
        frame~hidden,
        breakable,
        opacityback  = 0,
        opacityframe = 0,
        size         = minimal
      ]
      #1
    \end{tcolorbox}
  }
\cs_new:Npn \__examzh_solution_print_answer:n #1
  {
    \par
    \pushQED { \qed }
    % \normalfont \topsep6 \p@ \@plus6 \p@ \relax
    % \trivlist
    % \item \relax
    \group_begin:
      % \hspace* { 2\ccwd }
      \bfseries  \l__examzh_solution_label_content_tl  
      \@addpunct { \l__examzh_solution_label_punct_tl }
    \group_end:
    \hspace{0.5em} 
    % \ignorespaces
    \group_begin:
      \color { \l__examzh_solution_text_color_tl } #1
    \group_end:
    \bool_if:NT \l__examzh_solution_show_qed_bool
      { \popQED }
    % \endtrivlist 
    % \@endpefalse
  }

% https://github.com/CTeX-org/forum/issues/256#issuecomment-1172319787
\zref@require@unique

\NewDocumentCommand { \score } { O{} m }
  {
    \group_begin:
      \mode_if_math:TF
        { 
          \__examzh_score_math_version:n { #2 }
        }
        { 
          \__examzh_score_text_version:n { #2 }
        }
    \group_end:
  }
\cs_new:Npn \__examzh_score_math_version:n #1
  {
    \bool_if:NTF \l__examzh_score_show_leader_bool
      {
        \__examzh_math_cdotfill:n 
          { 
            \l__examzh_score_format_tl
            \l__examzh_score_pre_content_tl
            #1
            \l__examzh_score_post_content_tl 
          }
      }
      {
        \__examzh_math_nodotfill:n
          {
            { 
              \l__examzh_score_format_tl
              \l__examzh_score_pre_content_tl
              #1
              \l__examzh_score_post_content_tl 
            }
          }
      }
  }
\cs_new:Npn \__examzh_score_text_version:n #1
  {
    \bool_if:NTF \l__examzh_score_show_leader_bool
      {
        \__examzh_cdotfill:
        \l__examzh_score_format_tl
        \l__examzh_score_pre_content_tl #1 \l__examzh_score_post_content_tl 
      }
      {
        \hfill
        \l__examzh_score_format_tl
        \l__examzh_score_pre_content_tl #1 \l__examzh_score_post_content_tl
      }
    \par \noindent \ignorespaces
  }
% ä»¿ç…§ latex.ltx, line 651 çš„ \dotfill
\cs_new:Npn \__examzh_cdotfill:
  {
    \mode_leave_vertical:
    \cleaders
      \hbox_to_wd:nn { .44em } { \hss $\cdot$ \hss }
      \hfill \kern\z@
  }
\cs_new_protected:Npn \__examzh_math_nodotfill:n #1
  {
    \stepcounter { zref@unique }
    \hbox_overlap_right:n
      {
        \zsaveposx { \thezref@unique L }
        \zref@ifrefundefined { \thezref@unique R }
          { }
          {
            \skip_horizontal:n
              {
                  \zposx { \thezref@unique R } sp
                - \zposx { \thezref@unique L } sp
              }
          }
      }
    \tag * { \zsaveposx { \thezref@unique R } #1 }
  }
\cs_new_protected:Npn \__examzh_math_cdotfill:n #1
  {
    \stepcounter { zref@unique }
    \hbox_overlap_right:n
      {
        \zsaveposx { \thezref@unique L }
        \zref@ifrefundefined { \thezref@unique R }
          { }
          {
            \cleaders
              \hbox_to_wd:nn { .44em } { \hss $\cdot$ \hss }
              \skip_horizontal:n
                {
                    \zposx { \thezref@unique R } sp
                  - \zposx { \thezref@unique L } sp
                }
          }
      }
    \tag * { \zsaveposx { \thezref@unique R } #1 }
  }