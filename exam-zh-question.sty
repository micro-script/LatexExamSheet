%
% Copyright (c) 2022 Zeping Lee
% Released under the LaTeX Project Public License v1.3c License.
% Repository: https://gitee.com/zepinglee/exam-zh
%

\NeedsTeXFormat{LaTeX2e}

\RequirePackage{expl3}
\RequirePackage{xparse}

\ProvidesExplPackage {exam-zh-question} {2022-02-04} {v0.1.0}
    {exam-zh question module}


\RequirePackage{ulem}
% ulem å®åŒ…é‡å®šä¹‰äº† \emphï¼Œä½¿ç”¨ \normalem æ¢å¤
\normalem


% question çŽ¯å¢ƒçš„è®¡æ•°å™¨
\int_new:N \g__examzh_question_index_int
% question çŽ¯å¢ƒçš„å†…å®¹
\tl_new:N \l_examzh_question_answer_tl

% ç­”æ¡ˆé¢œè‰²
\tl_new:N \l__examzh_question_answer_color_tl
% é¢˜ç›®åˆ†æ•°
\int_new:N \l__examzh_question_points_int
% æ˜¯å¦æ˜¾ç¤ºé¢˜ç›®åˆ†æ•°
\bool_new:N \l__examzh_question_show_points_bool
\bool_new:N \l__examzh_question_show_points_auto_bool
% é¢˜ç›®åˆ†æ•°æ˜¯å¦å•ç‹¬æˆæ®µï¼Œè§£ç­”é¢˜éœ€è¦å•ç‹¬æˆæ®µ
\bool_new:N \l__examzh_question_points_separate_par_bool
% æ˜¯å¦æ˜¾ç¤ºæ‹¬å·
\bool_new:N \l__examzh_question_show_paren_bool
% æ˜¯å¦æ˜¾ç¤ºç­”æ¡ˆ
\bool_new:N \l__examzh_question_show_answer_bool
% ä¸Šä¸‹çš„é—´è·
\skip_new:N \l__examzh_question_top_sep_skip
\skip_new:N \l__examzh_question_bottom_sep_skip

\keys_define:nn { exam-zh }
  { question .meta:nn = { exam-zh / question } {#1} }


\keys_define:nn { exam-zh / question }
  {
    % ç­”æ¡ˆé¢œè‰²
    answer-color        .tl_set:N = \l__examzh_question_answer_color_tl ,
    % æ‰‹åŠ¨è°ƒæ•´question çŽ¯å¢ƒçš„è®¡æ•°å™¨
    index               .int_gset:N = \g__examzh_question_index_int ,
    % åˆ†æ•°
    points              .int_set:N = \l__examzh_question_points_int ,
    % åˆ†æ•°æ˜¾ç¤ºæŽ§åˆ¶
    show-points         .choice: ,
    show-points / auto  .code:n =
      { \bool_set_true:N \l__examzh_question_show_points_auto_bool } ,
    show-points / true  .code:n =
      {
        \bool_set_true:N  \l__examzh_question_show_points_bool
        \bool_set_false:N \l__examzh_question_show_points_auto_bool
      } ,
    show-points / false .code:n =
      {
        \bool_set_false:N \l__examzh_question_show_points_bool
        \bool_set_false:N \l__examzh_question_show_points_auto_bool
      } ,
    % åˆ†æ•°æ˜¯å¦å•ç‹¬æˆæ®µ
    points-separate-par .bool_set:N = \l__examzh_question_points_separate_par_bool ,
    % æ˜¯å¦æ˜¾ç¤ºé€‰æ‹©é¢˜çš„æ‹¬å·
    show-paren          .bool_set:N = \l__examzh_question_show_paren_bool ,
    % æ˜¯å¦æ˜¾ç¤ºç­”æ¡ˆ
    show-answer         .bool_set:N = \l__examzh_question_show_answer_bool ,
    % ä¸Šæ–¹é—´è·
    top-sep             .skip_set:N = \l__examzh_question_top_sep_skip ,
    % ä¸‹æ–¹é—´è·
    bottom-sep          .skip_set:N = \l__examzh_question_bottom_sep_skip ,
  }

\keys_set:nn { exam-zh / question }
  {
    answer-color        = black ,
    points              = 0 ,
    show-points         = auto ,
    points-separate-par = false ,
    show-paren          = false ,
    show-answer         = false ,
    top-sep             = .5em plus .5em minus .2em ,
    bottom-sep          = .5em plus .5em minus .2em ,
  }



% æ˜¯å¦æŒ‰ç…§è§£ç­”é¢˜çš„æ ¼å¼æŽ’ç‰ˆ
\bool_new:N \l__examzh_question_problem_style_bool


% é€‰æ‹©é¢˜å’Œå¡«ç©ºé¢˜çš„é¢˜å¹²
\NewDocumentEnvironment { question } { O { } +b }
  {
    \bool_set_false:N \l__examzh_question_problem_style_bool
    \__examzh_question_begin:nn {#1}{#2}
  }
  { \__examzh_question_end:nn {#1}{#2} }

% è§£ç­”é¢˜
\NewDocumentEnvironment { problem } { O { } +b }
  {
    \bool_set_true:N \l__examzh_question_problem_style_bool
    \__examzh_question_begin:nn {#1}{#2}
  }
  { \__examzh_question_end:nn {#1}{#2} }


\cs_new:Npn \__examzh_question_begin:nn #1#2
  {
    \par
    % é¢˜å¹²è®¡æ•°å™¨çš„å€¼åŠ ä¸€
    \int_gincr:N \g__examzh_question_index_int
    % ç­”æ¡ˆçš„å†…å®¹æ¸…ç©º
    \tl_clear:N \l_examzh_question_answer_tl
    % æ ¹æ®æ˜¯å¦æŒ‰è§£ç­”é¢˜æ–¹å¼æŽ’ç‰ˆæ¥è®¾ç½®æ˜¯å¦åˆ†æ•°è¦åˆ†æ®µ
    \bool_if:NTF \l__examzh_question_problem_style_bool
      { \keys_set:nn { exam-zh / question } { points-separate-par = true  } }
      { \keys_set:nn { exam-zh / question } { points-separate-par = false } }
    % è®¾ç½®é”®å€¼
    \keys_set:nn { exam-zh / question } { #1 }
    % è®¾ç½®ä¸Šæ–¹é—´è·
    \addvspace { \l__examzh_question_top_sep_skip }
    % ä¸¥æ ¼ç¦æ­¢å­¤è¡Œå’Œå¯¡è¡Œ
    \int_set:Nn \clubpenalty { 10000 }
    \int_set:Nn \widowpenalty { 10000 }
    % å°½é‡é¿å…åœ¨é¢˜ç›®ä¸­é—´æ¢è¡Œ
    \int_set:Nn \interlinepenalty { 301 }
    % è¿™éƒ¨åˆ†æ˜¯ä»¿ç…§ source2e ä¸­ enumerate çš„å®šä¹‰å†™çš„
    % \@enumdepth ä¸»è¦æŽ§åˆ¶ enumerate ä¸åŒå±‚çº§çš„ç¼–å·
    % è¿™æ ·è®¾ç½®åŽï¼Œåœ¨ question ä¸­ä½¿ç”¨ enumerate ä¼šè°ƒç”¨ level 2 çš„ç¼–å·
    % ä¹Ÿå°±æ˜¯ question ä¸­çš„ enumerate çŽ¯å¢ƒç›´æŽ¥ä»Žç¬¬äºŒå±‚å¼€å§‹
    \int_incr:N \@enumdepth
    % å¦‚æžœ show-points = auto é‚£ä¹ˆè§£ç­”é¢˜æ˜¾ç¤ºåˆ†æ•°ï¼Œå¡«ç©ºé¢˜å’Œé€‰æ‹©é¢˜çš„ä¸æ˜¾ç¤ºåˆ†æ•°
    % è¿™æ ·è®¾ç½®è€ƒè™‘åˆ°é€‰æ‹©é¢˜å’Œå¡«ç©ºé¢˜éƒ½æ˜¯æ¯é“é¢˜ä¸€æ ·çš„åˆ†æ•°ï¼Œåœ¨æœ€å¼€å§‹çš„åœ°æ–¹è¯´æ˜Žå³å¯
    % è€Œè§£ç­”é¢˜ä¸å¤ªä¸€æ ·
    \bool_if:NT \l__examzh_question_show_points_auto_bool
      {
        \bool_if:NTF \l__examzh_question_problem_style_bool
          { \bool_set_true:N  \l__examzh_question_show_points_bool }
          { \bool_set_false:N \l__examzh_question_show_points_bool }
      }
    % ä½¿ç”¨åˆ—è¡¨çŽ¯å¢ƒè¾“å‡º
    \list { \int_use:N \g__examzh_question_index_int . }
      {
        \dim_set:Nn \topsep    { 0pt }
        \dim_set:Nn \partopsep { 0pt }
        \dim_set:Nn \itemsep   { 0pt }
        \dim_set:Nn \parsep    { 0pt }
        \bool_if:NTF \l__examzh_question_problem_style_bool
          {
            % è§£ç­”é¢˜æ˜¯æ­£æ–‡ + ç¼©è¿› 2em çš„æ•ˆæžœ
            \dim_set:Nn \leftmargin { 0pt }
            \dim_set:Nn \itemindent { 2em }
          }
          {
            % é€‰æ‹©å’Œå¡«ç©ºé¢˜æ˜¯æ‚¬æŒ‚æ•ˆæžœ
            \dim_set:Nn \leftmargin { 2em }
            \dim_set:Nn \itemindent { 0pt }
          }
        \dim_set:Nn \labelsep   { .7em  }
        \dim_set:Nn \labelwidth { 1.3em }
        \dim_set_eq:NN \listparindent \itemindent
      }
    \item \relax
    % è¾“å‡ºé¢˜ç›®åˆ†æ•°
    \bool_if:NT \l__examzh_question_show_points_bool
      {
        % å¦‚æžœè®¾ç½®äº†åˆ†æ•°ä¸” show-points çš„ bool æ˜¯ true çš„è¯å°±æ˜¾ç¤º
        \int_compare:nNnT { \l__examzh_question_points_int } > { 0 }
          { ï¼ˆ \int_use:N \l__examzh_question_points_int ~ åˆ† ï¼‰ }
        % æ˜¯å¦åˆ†æ®µï¼ˆè§£ç­”é¢˜éœ€è¦åˆ†æ®µï¼‰
        \bool_if:NT \l__examzh_question_points_separate_par_bool
          % åº”è¯¥æ˜¯æŒ‡parå®Œä¹‹åŽé¿å…åˆ†é¡µï¼Œå¯¼è‡´å‡ºçŽ°åºå·å’Œåˆ†æ•°å‡ºçŽ°åœ¨é¡µé¢æœ€åŽä¸€è¡Œ
          { \par \nopagebreak }   
      }
  }


\cs_new:Npn \__examzh_question_end:nn #1#2
  {
    #2
    \endlist   % ç»“æŸåˆ—è¡¨çŽ¯å¢ƒ
    % å¢žåŠ ä¸‹æ–¹é—´è·
    \addvspace { \l__examzh_question_bottom_sep_skip }
  }


% é€‰æ‹©é¢˜æ‹¬å·
\NewDocumentCommand \paren { O { } }
  {
    % å¦‚æžœå¼€äº† show answer å°±é»˜è®¤ show paren 
    \bool_if:NT \l__examzh_question_show_answer_bool
      { \bool_set_true:N \l__examzh_question_show_paren_bool }
    \bool_if:NT \l__examzh_question_show_paren_bool
      {
        % ä½¿æ‹¬å·å•ç‹¬æˆè¡Œæ—¶å±…äºŽå³ä¾§
        % \null -> \hbox{}
        % ð–…ð–Šð–•ð–Žð–“ð–Œ ð•·ð–Šð–Š, [Mar 19, 2022 at 22:47:07]:
          % è¿™ä¸ªå†™æ³•æ˜¯ä¸ºäº†å¤„ç†è¿™æ ·çš„æƒ…å†µï¼šå‡è®¾æ‹¬å·éœ€è¦ 3em å®½åº¦ï¼Œä½†æ˜¯å¦‚æžœé¢˜å¹²æœ«å°¾åªå‰©ä¸‹äº† 2em çš„ç©ºç™½ï¼Œæ‹¬å·å°±å¿…è¦å¦èµ·ä¸€è¡Œï¼Œå¹¶ä¸”ç”¨ \hill æŠŠæ‹¬å·æŽ¨åˆ°æœ€å³ä¾§
          % æ‰€ä»¥ä¸­é—´ç”¨äº†ä¸¤ä¸ª \hfill
          % è‡³äºŽ \nobreak å’Œ \allowbreak å¤§æ¦‚æ˜¯ä¸ºäº†èƒ½å¤ŸåŒæ—¶å¤„ç†ã€Œæ‹¬å·ä¸æ¢è¡Œã€å’Œã€Œæ‹¬å·æ¢è¡Œã€ä¸¤ç§æƒ…å†µ
          % è¿™é‡Œå‚è€ƒ source2e çš„ \@dottedtoclineï¼ˆç›®å½•çš„æ ¼å¼ï¼‰
        \nobreak \hfill \allowbreak
        \null \nobreak \hfill \nobreak
        \hbox:n
          {
            ï¼ˆ
            \hbox_to_wd:nn { 3em }
              {
                \bool_if:NT \l__examzh_question_show_answer_bool
                  { \hfill \__examzh_question_print_answer:n {#1} \hfill }
              }
            ï¼‰ \kern -.4em
          }
      }
  }
% æœ¬æ„æ˜¯æ˜¾ç¤ºç­”æ¡ˆå†…å®¹ å› ä¸º show è¢«ç”¨ä½œâ€œæ˜¾ç¤ºä¸Žå¦â€çš„å«ä¹‰äº†ï¼Œæ‰€ä»¥æ­¤å¤„ç”¨ print
\cs_new:Npn \__examzh_question_print_answer:n #1
  {
    % \tl_set:Nn \l_examzh_question_answer_tl {#1}
    \group_begin:
      \tl_if_eq:NnF \l__examzh_question_answer_color_tl { black }
        { \exp_args:NV \color \l__examzh_question_answer_color_tl }
      #1
    \group_end:
  }

\bool_new:N \g__examzh_fillin_line_bool
\keys_define:nn { exam-zh / fillin }
  {
    type .choice:,
    type / line .code:n = 
      {
        \bool_gset_true:N \g__examzh_fillin_line_bool
      },
    type / paren .code:n = 
      {
        \bool_gset_false:N \g__examzh_fillin_line_bool
      }
  }
\keys_set:nn { exam-zh / fillin }
  {
    type = line
  }
\keys_define:nn { exam-zh }
  { fillin .meta:nn = { exam-zh / fillin } {#1} }


\dim_new:N \l__examzh_question_answer_depth_dim

% å¡«ç©ºå‘½ä»¤
\NewDocumentCommand \fillin { O { } }
  {
    % \tl_set:Nn \l_examzh_question_answer_tl {#1}
    \group_begin:
      % \ULdepth æ˜¯ \uline çš„ä¸‹åˆ’çº¿çš„æ·±åº¦
      \dim_set:Nn \ULdepth { 0.3em }
      % lazy ç‰ˆæœ¬æ˜¯æŒ‡éœ€è¦åˆ¤æ–­æ—¶æ‰åŽ»èŽ·å–å½“å‰ç”¨äºŽåˆ¤æ–­çš„ bool å€¼ 
      % è€Œä¸æ˜¯ç±»ä¼¼äºŽæå‰å±•å¼€çš„æ„Ÿè§‰ï¼Œå°±æ˜¯é¡¹å­è¶Šåœ¨ LaTeX3 çš„ b ç«™è§†é¢‘é‡Œè®²åˆ°çš„ lazy evaluation çš„å‘³é“
      \bool_lazy_and:nnTF
        { \bool_if_p:N \l__examzh_question_show_answer_bool }
        { \bool_not_p:n { \tl_if_empty_p:n {#1} } }
        {
          % ä¸ºä»€ä¹ˆè¦ç”¨ print answer çš„ #1 è€Œä¸æ˜¯ç›´æŽ¥ #1 å‘¢ï¼Ÿ
          % æ˜¯å› ä¸ºåŽé¢ç›´æŽ¥å°±é€šè¿‡ use_drop tmpa_box æ¥æ˜¾ç¤ºç­”æ¡ˆ
          % æ‰€ä»¥è¦æŠŠé¢œè‰²åŠ è¿›åŽ»
          \hbox_set:Nn \l_tmpa_box { \__examzh_question_print_answer:n {#1} }
          \dim_set:Nn \l__examzh_question_answer_depth_dim
            { \box_dp:N \l_tmpa_box }
          \bool_if:NTF \g__examzh_fillin_line_bool
            { \__examzh_fillin_uline_T: }
            { \__examzh_fillin_paren_T: }
        }
        { 
          \bool_if:NTF \g__examzh_fillin_line_bool
            { \__examzh_fillin_uline_F: }
            { \__examzh_fillin_paren_F: }
        }
      \group_end:
    \space \ignorespaces
  }

\cs_new:Npn \__examzh_fillin_uline_T:
  {
    \uline
      {
        \hspace* { 1em plus .5em minus .5em }
        \dim_compare:nNnTF { \l__examzh_question_answer_depth_dim } > { 0.2em }
          {
            \dim_sub:Nn \l__examzh_question_answer_depth_dim { 0.2em }
            \raisebox { \l__examzh_question_answer_depth_dim }
              { \box_use_drop:N \l_tmpa_box }
          }
          { \box_use_drop:N \l_tmpa_box }
        \hspace* { 1em plus .5em minus .5em }
      }
  }

\cs_new:Npn \__examzh_fillin_paren_T:
  {
    (
      \hspace* { 1em plus .5em minus .5em }
      \dim_compare:nNnTF { \l__examzh_question_answer_depth_dim } > { 0.2em }
        {
          \dim_sub:Nn \l__examzh_question_answer_depth_dim { 0.2em }
          \raisebox { \l__examzh_question_answer_depth_dim }
            { \box_use_drop:N \l_tmpa_box }
        }
        { \box_use_drop:N \l_tmpa_box }
      \hspace* { 1em plus .5em minus .5em }
    )
  }
\cs_new:Npn \__examzh_fillin_uline_F:
  {
    \uline { \hspace* { 3em plus 1em minus 1em } } 
  }
\cs_new:Npn \__examzh_fillin_paren_F:
  {
    ( \hspace* { 3em plus 1em minus 1em } )
  }